<!--{include header.htm}-->
<style>
#ul1, #ul2 {margin: 0px; padding: 0px;}
#ul1 li {width: 100px; float: left; margin: 0px; padding: 0px; list-style: none;}
#ul2 li {margin: 0px; padding: 0px; list-style: none;}
</style>
<div class="width" style="width: 960px;">
	<div>
		<ul id="ul1">
			<!--{loop $channellist $channel}-->
			<li>
				
				<input type="text" size="6" channelid="$channel[channelid]" value="$channel[name]" /><br />
				<a href="?cms-index-channelid-$channel[channelid].htm" {if $channelid == $channel[channelid]} class="bold red"{/if}>查看</a>
				&nbsp; <span class="icon icon-move"></span>
				<a href="" class="icon icon-delete"></a>
				
			</li>
			<!--{/loop}-->
			<li>
				<input type="text" size="6" channelid="$newchannelid" value="" islast="1" /><br />
				<a href="?cms-index-channelid-$newchannelid.htm">查看</a>
				&nbsp; <span class="icon icon-move"></span>
				<a href="" class="icon icon-delete"></a>
			</li>
		</ul>
	</div>
	
	<div style="clear: both; text-align: center; line-height: 30px; padding-top: 10px;">
		频道内容：$layoutradios
	</div>
	
	<table width="100%" width="100%">
		<tr>
			<!--{if $layout > 0}-->
			<td width="20%" valign="top">
				<ul id="ul2">
					<!--{loop $catelist $cate}-->
					<li>
						<input type="text" size="10" cateid="$cate[cateid]" value="$cate[name]" />
						<a href="?cms-index-channelid-$channelid-cateid-$cate[cateid].htm" {if $cateid == $cate[cateid]} class="bold red"{/if}>查看</a>
						&nbsp; <span href="" class="icon icon-move"></span>
						<a href="" class="icon icon-delete"></a>
					</li>
					<!--{/loop}-->
					<li>
						<input type="text" size="10" cateid="$newcateid" value="" islast="1" />
						<a href="?cms-index-channelid-$channelid-cateid-$newcateid.htm">查看</a>
						&nbsp; <span class="icon icon-move"></span>
						<a href="" class="icon icon-delete"></a>
					</li>
				</ul>
			</td>
			<!--{/if}-->
			<td valign="top">
				<!--{if $layout == 0 || $layout == 1}-->
								
				<form action="?cms-editarticle-channelid-$channelid-cateid-$cateid-ajax-1.htm" method="post" id="editarticle_form" target="_blank">
					<input type="hidden" name="FORM_HASH" value="{FORM_HASH}" />
					<div><textarea name="message" id="message" style="width: 100%; height: 400px;">$article[message]</textarea></div>
					<p><input type="submit" class="button bigblue" id="editarticle_submit" value="保存" /></p>
				</form>
				
				<!--{elseif $layout == 2}-->
				
				<div style="text-align: right;">
					<a href="?cms-createarticle-channelid-$channelid-cateid-$cateid-ajax-1.htm" class="ajaxdialog" onclick="return false;" id="create_thread" rel="nofollow"><span class="icon icon-post-newthread"></span> 添加文章</a>
				</div>
				<div class="div">
					<div class="header">
						<table width="100%">
							<tr>
								<td width="60">顺序</td>
								<td>标题</td>
								<td width="30">查看</td>
								<td width="60">操作</td>
							</tr>
						</table>
					</div>
					<div class="body">
						<table width="100%">
						<!--{loop $articlelist $article}-->
							<tr>
								<td width="60"><input type="text" name="articlerank[$article[articleid]]" articleid="$article[articleid]" value="$article[rank]" size="4" /></td>
								<td><a href="../?article-$articleid.htm" target="_blank" class="subject" articleid="$article[articleid]">$article[subject]</a></td>
								<td>$article[views]</td>
								<td width="60">
									<a href="?cms-updatearticle-channelid-$article[channelid]-cateid-$article[cateid]-articleid-$article[articleid].htm" class="ajaxdialog" ajaxdialog="{fullicon: true, modal: false, cache: false}" onclick="return false;">编辑</a>
									<a href="?cms-deletearticle-channelid-$article[channelid]-cateid-$article[cateid]-articleid-$article[articleid].htm" class="ajaxconfirm" ajaxconfirm="{message: '确定删除吗？'}" onclick="return false;">删除</a>
								</td>
							</tr>
							<tr>
								<td colspan="4"><hr /></td>
							</tr>
						<!--{/loop}-->
						</table>
						<div class="page" style="text-align: center">$pages</div>
					</div>
					<div class="footer"></div>
				</div>
				<div style="text-align: center;"><input type="button" class="button bigblue" value="批量设置顺序" id="rank_setting" /></div>
				
				<!--{/if}-->
				
			</td>
		</tr>
	</table>
</div>

<!--{include footer.htm}-->


<link href="../view/js/editor/editor.css" type="text/css" rel="stylesheet" />

<script type="text/javascript">
$.xload('../view/js/editor/swfupload.js', "../view/js/editor/editor.js", function() {
	$('#message').editor({
		onctrlenter: function() {
			$('#editarticle_submit').trigger('click');
		},
		
		onhook: function(_this) {
			var file_size_limit = '4MB';
			var upload_image_id   = _this._textarea.id + '_upload_button';
			$('a.image', _this.toolbar).append('<div id="' + upload_image_id + '" style=" width: 49px; height: 22px;"></div>');
			$('a.file', _this.toolbar).hide();
			var swf_settings = {
				flash_url : '../view/js/editor/swfupload.swf',
				upload_url: '?cms-uploadimage-articleid-$articleid-$conf[cookie_pre]sid-$_sid-$conf[cookie_pre]auth-$_auth-ajax-1.htm',
				prevent_swf_caching : false,
				preserve_relative_urls : false,
				//post_params: {"sid":"","auth":""},	// 我只能说 swfupload 很狗屎，传个参数还不稳定
				file_size_limit : file_size_limit,
				file_types : "*",
				file_types_description : "图片文件",
				file_upload_limit : 100,
				file_queue_limit : 0,
				custom_settings : {
					thumbnail_height: 120000,
					thumbnail_width: 1600,
					thumbnail_quality: 90
				},					debug: false,
				button_image_url: "../view/js/editor/uploadimage.png",
				button_width: "49",
				button_height: "22",
				button_placeholder_id: upload_image_id,
				button_text: '<span class="theFont">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>',
				button_text_style: ".theFont {font-size: 16;}",
				button_window_mode: SWFUpload.WINDOW_MODE.TRANSPARENT,	// chrome may be does not work!
				file_dialog_complete_handler : function(numFilesSelected, numFilesQueued) {
					//_this.save_bookmark();
					this.startUpload();
				},
				upload_start_handler : function(file) {
					$('a.image', _this.toolbar).width(0);
					$('a.imageloading', _this.toolbar).show();
					return true;
				},
				upload_progress_handler : function(file, bytesLoaded, bytesTotal) {
					var w = Math.ceil((bytesLoaded / bytesTotal) * 26);
					$('span.imageprocess_body', _this.toolbar).width(w);
				},
				upload_error_handler : function(file, errorCode, message) {
					alert('upload_error: file:'+file.name+', errorCode:'+errorCode+', message:'+message);
				},
				upload_success_handler : function(file, serverData) {
					var json = json_decode(serverData);
					if(error = json_error(json)) {alert(error); return false;}
					if(json.status <= 0) {alert(json.message); return false;}
					var s = json.message;
					_this.paste(s);
					return true;
				},
				file_queue_error_handler : function(file, errorCode, message) {
					if(errorCode == SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT) {
						alert('您选择的文件：'+file.name+' 尺寸('+file.size+')太大'+'！错误信息：'+message);
						$('.toolbar a.imageloading', _this).hide();
						return true;
					} else {
						alert('upload_queue_error: file:'+file+', errorCode:'+errorCode+', message:'+message);
					}
					return false;
				},
				queue_complete_handler : function(numFilesUploaded) {
					$('a.image', _this.toolbar).width(49);
					$('a.imageloading', _this.toolbar).hide();
				}
			};
			var swfu = new SWFUpload(swf_settings);
		},
		
		baseurl: '../view/js/editor/'
	});	
});
</script>

<script type="text/javascript" src="../view/js/jquery.dragsort-0.5.1.min.js"></script>
<script type="text/javascript">
// 兼容代码，以后可以去掉，common.js 里面有定义。
if(!window.urlencode) {
	function urlencode(s) {
		s = encodeURIComponent(s);
		s = s.replace(/\-/, '%2D');
		return s;
	}
}

$('a.ajaxconfirm').die('click').live('click', ajaxdialog_confirm);

var newchannelids = $newchannelids;
var newcateids = $newcateids;
newchannelids.reverse().pop();
newcateids.reverse().pop();

$('input[name=layout]').click(function() {
	var layout = intval($(this).val());
	window.location = '?cms-index-channelid-$channelid-layout-'+layout+'.htm';
});

// ----------> channel drag start
$("#ul1").dragsort({dragEnd: function(s) {
	var data = $("#ul1 li input").map(function() { return $(this).attr('channelid') + ':' + $(this).val(); }).get();
	var s = urlencode(data.join("|"));
	$.get('?cms-rankchannel-data-'+s+'-ajax-1.htm', function(s) {
		var json = json_decode(s);
		if(error = json_error(json)) {alert(error); return false;}
	});
}});
function li_bind_event(jli) {
	var jinput = jli.find('input');
	var name = urlencode(jinput.val());
	var channelid = intval(jinput.attr('channelid'));
	
	// 删除按钮
	jli.find('a.icon-delete').click(function() {
		if(jli.find('input').attr('islast') == 1) return false;
		if(window.confirm('确定删除?')) {
			$.get('?cms-deletechannel-channelid-'+channelid+'-ajax-1.htm', function(s) {
				var json = json_decode(s);
				if(error = json_error(json)) {alert(error); return false;}
				if(json.status == 1) {
					jli.remove();
				}
			});
		}
		return false;
	});
	
	// input keyup
	jinput.keyup(function() {
		var name = urlencode(jinput.val());
		var channelid = intval($(this).attr('channelid'));
		$.get('?cms-updatechannel-channelid-'+channelid+'-name-'+name+'-ajax-1.htm', function(s) {
			var json = json_decode(s);
			if(error = json_error(json)) {alert(error); return false;}
		});
		
		if(jinput.attr('islast') == '1') {
			var channelid = newchannelids.pop();
			if(!channelid) alert('最多只能添加20个频道！');
			//var channelid = intval(jinput.attr('channelid')) + 1; // channelid + 1
			var jliclone = jli.clone().appendTo(jli.parent());
			jliclone.find('input').val('').attr('channelid', channelid).attr('islast', '1');
			li_bind_event(jliclone);
		}
		jinput.attr('islast', '0');
	});
}
$('#ul1 li').each(function() {
	li_bind_event($(this));
});
// ----------> channel drag end




// ----------> cate drag start
$("#ul2").dragsort({dragEnd: function(s) {
	var data = $("#ul2 li input").map(function() { return $(this).attr('cateid') + ':' + $(this).val(); }).get();
	var s = urlencode(data.join("|"));
	$.get('?cms-rankcate-channelid-$channelid-data-'+s+'-ajax-1.htm', function(s) {
		var json = json_decode(s);
		if(error = json_error(json)) {alert(error); return false;}
	});
}});
function li_bind_event2(jli) {
	var jinput = jli.find('input');
	var name = urlencode(jinput.val());
	var cateid = intval(jinput.attr('cateid'));
	
	// 删除按钮
	jli.find('a.icon-delete').click(function() {
		if(jli.find('input').attr('islast') == 1) return false;
		if(window.confirm('确定删除?')) {
			$.get('?cms-deletecate-channelid-$channelid-cateid-'+cateid+'-ajax-1.htm', function(s) {
				var json = json_decode(s);
				if(error = json_error(json)) {alert(error); return false;}
				if(json.status == 1) {
					jli.remove();
				}
			});
		}
		return false;
	});
	
	// input keyup
	jinput.keyup(function() {
		var name = urlencode(jinput.val());
		var cateid = intval($(this).attr('cateid'));
		$.get('?cms-updatecate-channelid-$channelid-cateid-'+cateid+'-name-'+name+'-ajax-1.htm', function(s) {
			var json = json_decode(s);
			if(error = json_error(json)) {alert(error); return false;}
		});
		
		if(jinput.attr('islast') == '1') {
			var cateid = newcateids.pop();
			if(!cateid) alert('最多只能添加20个分类！');
			//var cateid = intval(jinput.attr('cateid')) + 1; // cateid + 1
			var jliclone = jli.clone().appendTo(jli.parent());
			jliclone.find('input').val('').attr('cateid', cateid).attr('islast', '1');
			li_bind_event2(jliclone);
		}
		jinput.attr('islast', '0');
	});
}
$('#ul2 li').each(function() {
	li_bind_event2($(this));
});
// ----------> cate drag end

</script>

<!--{if $layout == 0 || $layout == 1}-->
<script>
$('#editarticle_submit').click(function() {
	$('div.alert').remove();
	$('#editarticle_submit').disable();
	var postdata = $("#editarticle_form").serialize();
	$.post($('#editarticle_form').attr('action'), postdata,  function(s){
		$('#editarticle_form').enable();
		var json = json_decode(s);
		if(error = json_error(json)) {alert(error); return false;}
		if(json.status <=0) {
			alert(json.message);
			return false;
		}
		
		$.alert(json.message);
	});
	return false;
});
</script>
<!--{/if}-->

<!--{if $layout == 2}-->
<script>
$('#rank_setting').click(function() {
	var postdata = {};
	var data = $('input[name^=articlerank]').map(function() {postdata[$(this).attr('articleid')] = $(this).val(); });
	$.post('?cms-rankarticle-channelid-$channelid-cateid-$cateid-ajax-1.htm', {'rank': postdata}, function(s) {
		var json = json_decode(s);
		if(error = json_error(json)) {alert(error); return false;}
		
		$.alert(json.message);
		window.location.reload();
	});
});
</script>
<!--{/if}-->

$conf[footer_js]

</body>
</html>